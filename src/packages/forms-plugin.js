import t from"@swup/plugin";import{getCurrentUrl as e,Location as s}from"swup";class r extends t{constructor(t){void 0===t&&(t={}),super(),this.name="SwupFormsPlugin",this.requires={swup:">=4"},this.defaults={formSelector:"form[data-swup-form]",inlineFormSelector:"form[data-swup-inline-form]"},this.options=void 0,this.specialKeys={Meta:!1,Control:!1,Shift:!1},this.formSubmitDelegate=void 0,this.onKeyDown=t=>{this.specialKeys.hasOwnProperty(t.key)&&(this.specialKeys[t.key]=!0)},this.onKeyUp=t=>{this.specialKeys.hasOwnProperty(t.key)&&(this.specialKeys[t.key]=!1)},this.handleInlineForms=t=>{const{el:e}=t.trigger;if(!e?.matches(this.options.inlineFormSelector))return;if(!e.id)return void console.error("[@swup/forms-plugin] inline forms must have an id attribute:",e);const s=`#${e.id}`;t.containers=[s],t.animation.scope="containers",t.animation.selector=s,t.scroll.target=s;const r=t.a11y;"object"==typeof r&&(r.focus=s)},this.options={...this.defaults,...t}}mount(){this.swup.hooks.create("form:submit"),this.swup.hooks.create("form:submit:newtab"),this.formSubmitDelegate=this.swup.delegateEvent(this.options.formSelector,"submit",this.beforeFormSubmit.bind(this),{capture:!0}),this.on("visit:start",this.handleInlineForms,{priority:1}),document.addEventListener("keydown",this.onKeyDown),document.addEventListener("keyup",this.onKeyUp)}unmount(){this.formSubmitDelegate?.destroy(),document.removeEventListener("keydown",this.onKeyDown),document.removeEventListener("keyup",this.onKeyUp)}beforeFormSubmit(t){const s=this.swup,{delegateTarget:r,submitter:o}=t,i=this.getFormAttr("action",r,o)||e(),n=this.isSpecialKeyPressed(),a="_blank"===this.getFormAttr("target",r,o);if(n||a||!s.shouldIgnoreVisit(i,{el:r,event:t})){if(!a)return n?(s.hooks.callSync("form:submit:newtab",{el:r,event:t}),r.dataset.swupOriginalFormTarget=r.getAttribute("target")||"",r.setAttribute("target","_blank"),void r.addEventListener("submit",()=>requestAnimationFrame(()=>this.restorePreviousFormTarget(r)),{once:!0})):void s.hooks.callSync("form:submit",{el:r,event:t},()=>{this.submitForm(t)});s.hooks.callSync("form:submit:newtab",{el:r,event:t})}}restorePreviousFormTarget(t){t.dataset.swupOriginalFormTarget?t.setAttribute("target",t.dataset.swupOriginalFormTarget):t.removeAttribute("target")}submitForm(t){const e=t.delegateTarget,{url:s,hash:r,method:o,data:i,body:n}=this.getFormInfo(e,t);let a=s,m={method:o};switch(o){case"POST":m={method:o,body:n};break;case"GET":a=this.appendQueryParams(a,i);break;default:return void console.warn(`Unsupported form method: ${o}`)}t.preventDefault(),this.swup.cache.delete(a),this.swup.navigate(a+r,m,{el:e,event:t})}getFormInfo(t,r){let{submitter:o}=r;const i=(this.getFormAttr("method",t,o)||"get").toUpperCase(),n=this.getFormAttr("action",t,o)||e(),{url:a,hash:m}=s.fromUrl(n),u=(this.getFormAttr("enctype",t,o)||"application/x-www-form-urlencoded").toLowerCase(),l="multipart/form-data"===u,h=new FormData(t);let c;return c=l?h:new URLSearchParams(h),{url:a,hash:m,method:i,data:h,body:c,encoding:u}}getFormAttr(t,e,s){return void 0===s&&(s=null),s?.getAttribute(`form${t}`)??e.getAttribute(t)}appendQueryParams(t,e){const s=t.split("?")[0],r=new URLSearchParams(e).toString();return r?`${s}?${r}`:s}isSpecialKeyPressed(){return Object.values(this.specialKeys).some(t=>t)}resetSpecialKeys(){for(const t of Object.keys(this.specialKeys))this.specialKeys[t]=!1}}export{r as default};
//# sourceMappingURL=index.module.js.map
