import t from"@swup/plugin";import{Location as e,classify as r,matchPath as n}from"swup";const o=(t,e,r)=>null==t?t:`[${e}m${String(t)}[${r}m`,s=t=>`ðŸ§© ${(t=>o(t,1,22))(t)}`,i=t=>(t=>o(t,91,39))(t);class a{log(){var t=[].slice.call(arguments);const e=t.shift();console.log(s(e),...t)}warn(){var t=[].slice.call(arguments);const e=t.shift();console.warn(s(e),...t)}error(){var t=[].slice.call(arguments);const e=t.shift();console.error(s(e),...t)}logIf(t){t&&this.log(...[].slice.call(arguments,1))}warnIf(t){t&&this.warn(...[].slice.call(arguments,1))}errorIf(t){t&&this.error(...[].slice.call(arguments,1))}}window.process||(window.process={}),window.process.env||(window.process.env={});const c="development"===process.env.NODE_ENV,l=t=>{!function(t){let{rules:r,swup:n,logger:o}=t;const s=n.getCurrentUrl();r.filter(t=>t.matchesFrom(s)||t.matchesTo(s)).forEach(t=>{t.containers.forEach(t=>{const r=document.querySelector(`${t}:not([data-swup-fragment])`);if(!r)return;const n=r.getAttribute("data-swup-fragment-url");n&&c&&o?.log(`fragment url ${i(n)} for ${i(t)} provided by server`);const{url:a}=e.fromUrl(n||s);r.setAttribute("data-swup-fragment",""),r.__swupFragment={url:a,selector:t}})})}(t),function(t){let{logger:e,swup:r}=t;const n="data-swup-link-to-fragment";document.querySelectorAll(`a[${n}]`).forEach(t=>{const o=t.getAttribute(n);if(!o)return void(c&&e?.warn(`[${n}] needs to contain a valid fragment selector`));const s=document.querySelector(o);if(!s)return void(c&&e?.warn(`no element found for [${n}="${o}"]`));const i=s.__swupFragment?.url;i?m(i,r.getCurrentUrl())?c&&e?.warn(`The fragment URL of ${o} is identical to the current URL. This could mean that [data-swup-fragment-url] needs to be provided by the server.`):t.href=i:c&&e?.warn(`no fragment infos found on ${o}`)})}(t),function(t){let{logger:e}=t;document.querySelectorAll("dialog[data-swup-fragment]").forEach(t=>{t.__swupFragment?t.__swupFragment.modalShown||(t.__swupFragment.modalShown=!0,t.removeAttribute("open"),t.showModal()):c&&e?.warn("fragment properties missing on element:",t)})}(t)},u=(t,e)=>{const r=t.__swupFragment?.url;return!!r&&m(r,e)},m=(t,e)=>f(t)===f(e),f=t=>{if(!t.trim())return t;const r=e.fromUrl(t);return r.searchParams.sort(),((n=r.pathname).endsWith("/")?n.slice(0,-1):n)+r.search;var n},g=t=>{const e=t.from.url,r=t.to.url;if(e&&r)return{from:e,to:r}},h=t=>{if(!t.fragmentVisit)return;const{rule:e,containers:r}=t.fragmentVisit;e.name&&r.forEach(t=>{document.querySelector(t)?.classList.add(`to-${e.name}`)})},d=(t,e)=>e.find(e=>e.matches(t));function p(t){let{swup:e}=t;const{fragmentVisit:r}=e.visit;return!!r&&r.containers.every(t=>"template"===document.querySelector(t)?.tagName?.toLowerCase())}function w(t,e){const r=d(t,this.rules);if(!r)return;const n=((t,e,r)=>e.filter(e=>{const n=document.querySelector(e);return n?!u(n,t.to)||(c&&r?.log(`ignored fragment ${i(e)} as it already matches the current URL`),!1):(c&&r?.log(`fragment "${e}" missing in current document`),!1)}))(t,r.containers,e);return n.length?{rule:r,containers:n}:void 0}class v{constructor(t,e,o,s,i){this.matchesFrom=void 0,this.matchesTo=void 0,this.from=void 0,this.to=void 0,this.containers=void 0,this.name=void 0,this.from=t||"",this.to=e||"",s&&(this.name=r(s)),this.containers=this.parseContainers(o,i),c&&(i?.errorIf(!e,"Every fragment rule must contain a 'to' path",this),i?.errorIf(!t,"Every fragment rule must contain a 'from' path",this)),this.matchesFrom=n(t),this.matchesTo=n(e)}parseContainers(t,e){if(!Array.isArray(t))return c&&e?.error("Every fragment rule must contain an array of containers",this),[];const r=t.map(t=>t.trim());return r.forEach(t=>{const r=this.validateSelector(t);r instanceof Error&&e?.error(r)}),[...new Set(r)]}validateSelector(t){return t.startsWith("#")?!t.match(/\s|>/)||new Error(`fragment selectors must not be nested: ${t}`):new Error(`fragment selectors must be IDs: ${t}`)}matches(t){return!1!==this.matchesFrom(t.from)&&!1!==this.matchesTo(t.to)}}const $=function(t){const e=g(t);e&&d(e,this.rules)&&(t.scroll.reset=!1)},y=function(t){try{const e=this,r=g(t);if(!r)return Promise.resolve();const n=w.call(e,r,e.logger);return n?(t.fragmentVisit=n,c&&e.logger?.log(`fragment visit: ${i(t.fragmentVisit.containers.join(", "))}`),t.scroll.reset=!1,t.animation.scope=t.fragmentVisit.containers,t.containers=t.fragmentVisit.containers,t.animation.selector=t.fragmentVisit.containers.join(","),h(t),Promise.resolve()):Promise.resolve()}catch(t){return Promise.reject(t)}},S=function(t,e){t.fragmentVisit&&p(this)&&(c&&this.logger?.log(`${i("out")}-animation skipped for ${i(t.fragmentVisit?.containers.toString())}`),e.skip=!0)},_=function(t,e){t.fragmentVisit&&p(this)&&(c&&this.logger?.log(`${i("in")}-animation skipped for ${i(t.fragmentVisit?.containers.toString())}`),e.skip=!0)},F=function(t,e){if(t.trigger.el||!t.to.url)return;const r=this.swup.cache.get(t.to.url);r&&r.fragmentHtml&&(e.page.html=r.fragmentHtml,c&&this.logger?.log(`fragment cache used for ${i(t.to.url)}`))},b=function(t){h(t),l(this),(t=>{let{swup:e,logger:r}=t;const n=e.getCurrentUrl(),o=e.cache,s=o.get(n);if(!s)return;const a=(new DOMParser).parseFromString(s.html,"text/html"),l=[],m=Array.from(document.querySelectorAll("[data-swup-fragment]")).filter(t=>!t.matches("template")&&!u(t,n));m.length&&(e.options.cache?(m.forEach(t=>{if(null!=t.querySelector("[data-swup-fragment]"))return;const e=t.__swupFragment?.url;if(!e)return void(c&&r?.warn("no fragment url found:",t));const n=t.__swupFragment?.selector;if(!n)return void(c&&r?.warn("no fragment selector found:",t));const s=o.get(e);if(!s)return;const i=a.querySelector(n);if(!i)return;const u=(new DOMParser).parseFromString(s.html,"text/html").querySelector(n);u&&(u.setAttribute("data-swup-fragment-url",e),i.replaceWith(u),l.push(t))}),l.length&&(o.update(n,{...s,fragmentHtml:a.documentElement.outerHTML}),l.forEach(t=>{const e=t.__swupFragment?.url||"",n=t.__swupFragment?.selector||"";c&&r?.log(`updated cache with ${i(n)} from ${i(e)}`)}))):c&&r?.warn("can't cache foreign fragment elements without swup's cache"))})(this)},E=function(t){t.fragmentVisit&&(t=>{let{rule:e,containers:r}=t;e.name&&r.forEach(t=>{document.querySelector(t)?.classList.remove(`to-${e.name}`)})})(t.fragmentVisit),t.fragmentVisit=void 0};class V extends t{constructor(t){super(),this.name="SwupFragmentPlugin",this.requires={swup:">=4"},this.rules=[],this.options=void 0,this.defaults={rules:[],debug:!1},this.logger=void 0,this.options={...this.defaults,...t},c&&this.options.debug&&(this.logger=new a),this.rules=this.options.rules.map(t=>{let{from:e,to:r,containers:n,name:o}=t;return new v(e,r,n,o,this.logger)})}mount(){const t=this.swup;this.before("link:self",$),this.on("visit:start",y),this.before("animation:out:await",S),this.before("animation:in:await",_),this.before("content:replace",F),this.on("content:replace",b),this.on("visit:end",E),t.getFragmentVisit=w.bind(this),c&&this.logger?.warnIf(!t.options.cache,"fragment caching will only work with swup's cache being active"),l(this)}unmount(){super.unmount(),this.swup.getFragmentVisit=void 0,document.querySelectorAll("[data-swup-fragment]").forEach(t=>{t.removeAttribute("data-swup-fragment-url"),delete t.__swupFragment})}}export{V as default};
//# sourceMappingURL=index.module.js.map
