import e from"@swup/plugin";import{getCurrentUrl as t,Location as r}from"swup";import o from"throttles/priority";class s extends e{constructor(e){void 0===e&&(e={}),super();const t=this;this.name="SwupPreloadPlugin",this.requires={swup:">=4"},this.defaults={throttle:5,preloadInitialPage:!0,preloadHoveredLinks:!0,preloadVisibleLinks:{enabled:!1,threshold:.2,delay:500,containers:["body"]}},this.options=void 0,this.queue=void 0,this.preloadPromises=new Map,this.preloadObserver=void 0,this.mouseEnterDelegate=void 0,this.touchStartDelegate=void 0,this.onPageLoad=(e,t,r)=>{const{url:o}=e.to;return this.preloadPromises.has(o)?this.preloadPromises.get(o):r?.(e,t)},this.onMouseEnter=function(e){try{if(e.target!==e.delegateTarget)return Promise.resolve();if(!t.deviceSupportsHover())return Promise.resolve();const r=e.delegateTarget;return r instanceof HTMLAnchorElement?(t.swup.hooks.callSync("link:hover",{el:r,event:e}),t.preload(r,{priority:!0}),Promise.resolve()):Promise.resolve()}catch(e){return Promise.reject(e)}},this.onTouchStart=e=>{if(this.deviceSupportsHover())return;const t=e.delegateTarget;t instanceof HTMLAnchorElement&&this.preload(t,{priority:!0})};const{preloadVisibleLinks:r,...s}=e;this.options={...this.defaults,...s},"object"!=typeof r&&(this.options.preloadVisibleLinks.enabled=Boolean(r)),this.preload=this.preload.bind(this);const[i,a]=o(this.options.throttle);this.queue={add:i,next:a}}mount(){const e=this.swup;e.options.cache?(e.hooks.create("page:preload"),e.hooks.create("link:hover"),e.preload=this.preload,e.preloadLinks=this.preloadLinks,this.mouseEnterDelegate=e.delegateEvent(e.options.linkSelector,"mouseenter",this.onMouseEnter,{capture:!0}),this.touchStartDelegate=e.delegateEvent(e.options.linkSelector,"touchstart",this.onTouchStart,{capture:!0}),this.replace("page:load",this.onPageLoad),this.options.preloadHoveredLinks&&(this.preloadLinks(),this.on("page:view",()=>this.preloadLinks())),this.options.preloadVisibleLinks.enabled&&(this.preloadVisibleLinks(),this.on("page:view",()=>this.preloadVisibleLinks())),this.options.preloadInitialPage&&this.preload(t())):console.warn("SwupPreloadPlugin: swup cache needs to be enabled for preloading")}unmount(){this.swup.preload=void 0,this.swup.preloadLinks=void 0,this.preloadPromises.clear(),this.mouseEnterDelegate?.destroy(),this.touchStartDelegate?.destroy(),this.stopPreloadingVisibleLinks()}deviceSupportsHover(){return window.matchMedia("(hover: hover)").matches}preload(e,t){void 0===t&&(t={});try{const o=this;let s,i;const a=t.priority??!1;return Array.isArray(e)?Promise.all(e.map(e=>o.preload(e))):(e instanceof HTMLAnchorElement?(i=e,({url:s}=r.fromElement(e))):s=String(e),o.shouldPreload(s,i)?Promise.resolve(new Promise(e=>{o.queue.add(()=>{const t=o.performPreload(s);o.preloadPromises.set(s,t),t.catch(()=>{}).then(t=>e(t)).finally(()=>{o.queue.next(),o.preloadPromises.delete(s)})},a)})):Promise.resolve())}catch(e){return Promise.reject(e)}}preloadLinks(){requestIdleCallback(()=>{Array.from(document.querySelectorAll("a[data-swup-preload], [data-swup-preload-all] a")).forEach(e=>this.preload(e))})}preloadVisibleLinks(){if(this.preloadObserver)return void this.preloadObserver.update();const{threshold:e,delay:t,containers:r}=this.options.preloadVisibleLinks,o=new Set,s=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting?i(e.target):a(e.target)})},{threshold:e}),i=e=>{o.add(e.href),setTimeout(()=>{o.has(e.href)&&(this.preload(e.href),s.unobserve(e))},t)},a=e=>o.delete(e.href),n=()=>{requestIdleCallback(()=>{const e=r.map(e=>`${e} a[href]`).join(", ");Array.from(document.querySelectorAll(e)).filter(e=>!this.triggerWillOpenNewWindow(e)).forEach(e=>s.observe(e))})};n(),this.preloadObserver={stop:()=>s.disconnect(),update:()=>(o.clear(),n())}}stopPreloadingVisibleLinks(){this.preloadObserver&&this.preloadObserver.stop()}shouldPreload(e,o){const{url:s,href:i}=r.fromUrl(e);return!(!this.networkSupportsPreloading()||this.swup.cache.has(s)||this.preloadPromises.has(s)||this.swup.shouldIgnoreVisit(i,{el:o})||o&&s===t())}networkSupportsPreloading(){if(navigator.connection){if(navigator.connection.saveData)return!1;if(navigator.connection.effectiveType?.endsWith("2g"))return!1}return!0}triggerWillOpenNewWindow(e){return e.matches('[download], [target="_blank"]')||e.origin!==window.location.origin}performPreload(e){try{const t=this;return Promise.resolve(t.swup.fetchPage(e)).then(function(e){return Promise.resolve(t.swup.hooks.call("page:preload",{page:e})).then(function(){return e})})}catch(e){return Promise.reject(e)}}}export{s as default};
//# sourceMappingURL=index.module.js.map
